const fs = require("fs");
const path = require("path");
const moment = require("moment-timezone");

const TIMEZONE = "Asia/Dhaka";
const DATA_FILE = path.join(__dirname, "lastHour.json");

const header = `
тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
ЁЯОАЁЭЧзЁЭЧШЁЭЧжЁЭЧжЁЭЧФ ЁЭЧзЁЭЧЬЁЭЧаЁЭЧШ ЁЭЧеЁЭЧвЁЭЧиЁЭЧзЁЭЧЬЁЭЧбЁЭЧШЁЯеА
тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
`;
const routine = {
  "00": "ЁЯМЩ рж░рж╛ржд рззрзиржЯрж╛ ржмрж╛ржЬрзЗред\nржорзЛржмрж╛ржЗрж▓ рж╕рж╛ржЗрж▓рзЗржирзНржЯ ржХрж░рзЗ ржкрж╛ржирж┐ ржЦрзЗрзЯрзЗ ржШрзБржорж╛рждрзЗ ржпрж╛ржУ, ржХрж╛рж▓ ржХрж┐ржирзНрждрзБ ржЕржирзЗржХ ржХрж╛ржЬ рждрзЛржорж╛рж░ ржЕржкрзЗржХрзНрж╖рж╛рзЯ! ЁЯШ┤",

  "01": "ЁЯТА рж░рж╛ржд рззржЯрж╛ ржмрж╛ржЬрзЗред\nржпрж╛рж░рж╛ ржПржЦржиржУ ржЕржирж▓рж╛ржЗржирзЗ ржЖржЫрзЛ, рж╢рзЗрж╖ рж╕рзНржХрзНрж░рж▓ ржХрж░рзЗ рж▓ржЧржЖржЙржЯ рж╣ржУ, ржирж╛ рж╣рж▓рзЗ ржЪрзЛржЦрзЗрж░ ржирж┐ржЪрзЗ ржХрж╛рж▓рж┐ ржлрзНрж░рж┐ ржЕржл ржХрж╕рзНржЯ! ЁЯШк",

  "02": "ЁЯШ╢тАНЁЯМля╕П рж░рж╛ржд рзиржЯрж╛ ржмрж╛ржЬрзЗред\nржкрзБрж░ржирзЛ ржЪрзНржпрж╛ржЯ/ржорзЗрж╕рзЗржЬ ржШрж╛ржБржЯрж╛ржШрж╛ржБржЯрж┐ ржмржирзНржз ржХрж░рзЗ тАШрж╕рждрзНржпрж┐ рж╕рждрзНржпрж┐тАЩ ржШрзБржорж╛ржУ, рж╕рзНржмржкрзНржирзЗржУ рждрзЛ ржЪрзНржпрж╛ржЯ ржХрж░рж╛ ржпрж╛рзЯ ЁЯШП",

  "03": "ЁЯСА рж░рж╛ржд рзйржЯрж╛ ржмрж╛ржЬрзЗред\nржпрж╛ржжрзЗрж░ рждржУржмрж╛/рж░рж┐ржлрзНрж▓рзЗржХрзНржЯ ржХрж░рж╛рж░ ржжрж░ржХрж╛рж░ ржЖржЫрзЗ, ржПржХржЯрзБ ржирж┐ржЬрзЗрж░ ржЬрзАржмржирзЗрж░ ржирж┐рзЯрзЗ ржнрж╛ржмрзЛ; ржЖрж░ ржпрж╛ржжрзЗрж░ ржЕрзНржпрж╛рж╕рж╛ржЗржиржорзЗржирзНржЯ ржЖржЫрзЗ, ржХрж╛рж▓ржХрзЗ ржХрж░рзЗ рж▓рж╛ржн ржирж╛ржЗтАФржПржЦржиржЗ ржПржХржЯрзБ рж╢рзБрж░рзБ ржХрж░рзЛ ЁЯШЖ",

  "04": "тЬи ржнрзЛрж░ рзкржЯрж╛ ржмрж╛ржЬрзЗред\nржПржХржЯрзБ ржжрзЛрзЯрж╛ ржХрж░рзЛ, ржоржи рж╢рж╛ржирзНржд ржХрж░рзЛ, рждрж╛рж░ржкрж░ ржлржЬрж░рзЗрж░ ржЬржирзНржп рж░рзЗржбрж┐ рж╣ржУ; ржирж╛рж╣рж▓рзЗ ржЕрзНржпрж╛рж▓рж╛рж░рзНржо рж╢рзБржирзЗржУ ржЙржарждрзЗ ржкрж╛рж░ржмрзЗ ржирж╛ ЁЯШм",

  "05": "ЁЯМдя╕П ржнрзЛрж░ рзлржЯрж╛ ржмрж╛ржЬрзЗред\nржлржЬрж░рзЗрж░ ржирж╛ржорж╛ржЬ ржЖрж░ ржлрзНрж░рзЗрж╢ ржмрж╛рждрж╛рж╕тАФржжрзБржЯрзЛржЗ ржорж┐рж╕ ржХрзЛрж░рзЛ ржирж╛, рж╕рж╛рж░рж╛ржжрж┐ржирзЗрж░ ржорзБржб ржПржХржжржо рж╕рзЗржЯ рж╣рзЯрзЗ ржпрж╛ржмрзЗ ЁЯШМ",

  "06": "ЁЯза рж╕ржХрж╛рж▓ рзмржЯрж╛ ржмрж╛ржЬрзЗред\nржЕрзНржпрж╛рж▓рж╛рж░рзНржо тАШрж╕рзНржирзБржЬтАЩ ржХрж░рж╛ ржмржирзНржз ржХрж░рзЗ рж╕рждрзНржпрж┐ рж╕рждрзНржпрж┐ ржЙржарзЛ, ржирж╛ рж╣рж▓рзЗ ржорж╛тАЩрж░ ржирзНржпрж╛ржЪрж╛рж░рж╛рж▓ ржЕрзНржпрж╛рж▓рж╛рж░рзНржо рж╢рзБрж░рзБ рж╣ржмрзЗ ЁЯШ╝",

  "07": "ЁЯНЮ рж╕ржХрж╛рж▓ рзнржЯрж╛ ржмрж╛ржЬрзЗред\nржжрж╛ржБржд ржорж╛ржЬрзЛ, ржлрзНрж░рзЗрж╢ рж╣ржУ, ржирж╛рж╢рждрж╛ ржХрж░рзЛ тАУ ржЦрж╛рж▓рж┐ ржкрзЗржЯрзЗ рж╣рж┐рж░рзЛ рж╣рждрзЗ ржпрзЗржУ ржирж╛ ЁЯШО",

  "08": "ЁЯОТ рж╕ржХрж╛рж▓ рзоржЯрж╛ ржмрж╛ржЬрзЗред\nрж╕рзНржХрзБрж▓/ржХрж▓рзЗржЬ/ржХрзНрж▓рж╛рж╕рзЗ ржпрж╛ржУрзЯрж╛рж░ ржЖржЧрзЗ ржмрзНржпрж╛ржЧ ржЪрзЗржХ ржХрж░рзЛ тАУ ржЖржЗржбрж┐ ржХрж╛рж░рзНржб, ржХрж▓ржо, ржЦрж╛рждрж╛ ржЖрж░ рждрзЛржорж╛рж░ ржорзБржЦржЯрж╛ тАУ рж╕ржм ржарж┐ржХ ржЖржЫрзЗ рждрзЛ? ЁЯШД",

  "09": "ЁЯУЪ рж╕ржХрж╛рж▓ рзпржЯрж╛ ржмрж╛ржЬрзЗред\nржоржи ржжрж┐ржпрж╝рзЗ ржкрзЬрж╛рж╢рзЛржирж╛ ржХрж░рзЛ, ржХрзНрж▓рж╛рж╕рзЗ ржмрж╕рзЗ ржлрзЗрж╕ржмрзБржХ рж╕рзНржХрзНрж░рж▓ ржХрж░рж▓рзЗ рж╕рзНржпрж╛рж░ржУ ржПржХржжрж┐ржи рждрзЛржорж╛рж░ рж░рзЗржЬрж╛рж▓рзНржЯ рж╕рзНржХрзНрж░рж▓ ржХрж░рзЗ ржжрзЗржЦрж╛ржмрзЗ ЁЯШП",

  "10": "ЁЯдЭ рж╕ржХрж╛рж▓ рззрзжржЯрж╛ ржмрж╛ржЬрзЗред\nржЯрзБ-ржбрзБ рж▓рж┐рж╕рзНржЯ ржжрзЗржЦрзЗ ржирж╛ржУ, ржХрзЛржи ржХрж╛ржЬржЧрзБрж▓рзЛ ржЖржЬржХрзЗ рж╢рзЗрж╖ ржХрж░рждрзЗржЗ рж╣ржмрзЗ рж╕рзЗржЯрж╛рж░ ржкрзНрж░рж╛ржЗржУрж░рж┐ржЯрж┐ ржарж┐ржХ ржХрж░рзЛ, ржорж╛ржерж╛рж░ рж▓рзЛржб ржЕржирзЗржХ ржХржорзЗ ржпрж╛ржмрзЗ ЁЯЩВ",

  "11": "ЁЯУ╡ рж╕ржХрж╛рж▓ рззрззржЯрж╛ ржмрж╛ржЬрзЗред\nржПржХржЯрзБ ржорзЛржмрж╛ржЗрж▓ ржерзЗржХрзЗ ржжрзВрж░рзЗ ржЧрж┐рзЯрзЗ ржкрж╛ржирж┐ ржЦрж╛ржУ, ржЪрзЛржЦ ржЖрж░ ржмрзНрж░рзЗржЗржи ржжрзБржЯрзЛржЗ ржПржХржЯрзБ рж░рзЗрж╕рзНржЯ ржкрж╛ржХ ЁЯза",

  "12": "тШАя╕П ржжрзБржкрзБрж░ рззрзиржЯрж╛ ржмрж╛ржЬрзЗред\nрж╣рж╛рж▓ржХрж╛ ржмрж┐рж░рждрж┐ ржирж╛ржУ, ржкрж╛ржирж┐ ржЦрж╛ржУ, рж╕рж╛ржорж╛ржирзНржп рж╣рж╛ржБржЯрзЛ тАУ рж╕рж╛рж░рж╛ржжрж┐ржирзЗрж░ ржПржирж╛рж░рзНржЬрж┐ ржЖржк ржерж╛ржХржмрзЗред",

  "13": "ЁЯНЫ ржжрзБржкрзБрж░ рззржЯрж╛ ржмрж╛ржЬрзЗред\nржжрзБржкрзБрж░рзЗрж░ ржЦрж╛ржмрж╛рж░ ржЯрж╛ржЗржо! ржорзЛржмрж╛ржЗрж▓ рж╣рж╛рждрзЗ ржирж┐рзЯрзЗ ржирж╛ ржЦрзЗрзЯрзЗ, ржПржХржЯрзБ ржкрж░рж┐ржмрж╛рж░/ржмржирзНржзрзБрж░ рж╕рж╛ржерзЗ ржХржерж╛ ржмрж▓рждрзЗ ржмрж▓рждрзЗ рж╢рж╛ржирзНрждрж┐рждрзЗ ржЦрж╛ржУ ЁЯЩВ",

  "14": "ЁЯШ┤ ржжрзБржкрзБрж░ рзиржЯрж╛ ржмрж╛ржЬрзЗред\nржХрж╛ржЬ/ржХрзНрж▓рж╛рж╕ рж╢рзЗрж╖ рж╣рж▓рзЗ рзирзж-рзйрзж ржорж┐ржирж┐ржЯ ржкрж╛ржУрзЯрж╛рж░ ржирзНржпрж╛ржк ржжрж┐рждрзЗ ржкрж╛рж░рзЛ, рждржмрзЗ тАШрж╕ржирзНржзрзНржпрж╛ ржкрж░рзНржпржирзНржд ржШрзБржотАЩ ржЕржлрж╕рж╛ржЗржб ЁЯШЖ",

  "15": "ЁЯУЦ ржмрж┐ржХрж╛рж▓ рзйржЯрж╛ ржмрж╛ржЬрзЗред\nрж╕рзНржЯрзБржбрзЗржирзНржЯ рж╣рж▓рзЗ ржирзЛржЯ ржЧрзБржЫрж┐рзЯрзЗ ржирж╛ржУ, ржЕржлрж┐рж╕-ржУрзЯрж╛рж░рзНржХрж╛рж░ рж╣рж▓рзЗ ржЖржЬржХрзЗрж░ ржХрж╛ржЬржЧрзБрж▓рзЛ ржПржХржЯрзБ рж░рж┐ржнрж┐ржЙ ржХрж░рзЗ ржирж╛ржУред",

  "16": "ЁЯХМ ржмрж┐ржХрж╛рж▓ рзкржЯрж╛ ржмрж╛ржЬрзЗред\nржпрж╛рж░рж╛ ржирж╛ржорж╛ржЬ ржкрзЬрзЛ, ржкрзНрж░рж╕рзНрждрзБрждрж┐ ржирж╛ржУ; ржЖрж░ рж╕ржмрж╛ржЗ ржПржХржЯрзБ ржЖржХрж╛рж╢рзЗрж░ ржжрж┐ржХрзЗ рждрж╛ржХрж┐рзЯрзЗ ржбрзЗ-ржбрзНрж░рж┐ржо ржирж╛ ржХрж░рзЗ ржирж┐ржЬрзЗрж░ ржнржмрж┐рж╖рзНржпрждрзЗрж░ ржкрзНрж▓рзНржпрж╛ржи ржХрж░рзЛ ЁЯШМ",

  "17": "ЁЯПГ ржмрж┐ржХрж╛рж▓ рзлржЯрж╛ ржмрж╛ржЬрзЗред\nржПржХржЯрзБ рж╣рж╛ржБржЯрж╛рж╣рж╛ржБржЯрж┐, рж░рзБржлржЯржк/ржорж╛ржарзЗ ржЧрж┐рзЯрзЗ ржлрзНрж░рзЗрж╢ рж╣рзЯрзЗ ржЖрж╕рзЛ, рж╕рж╛рж░рж╛ржжрж┐ржирзЗрж░ рж╕рзНржЯрзНрж░рзЗрж╕ ржПржХржЯрзБ ржЭрзЗрзЬрзЗ ржлрзЗрж▓рзЛред",

  "18": "ЁЯПб рж╕ржирзНржзрзНржпрж╛ рзмржЯрж╛ ржмрж╛ржЬрзЗред\nрж╣рж╛ржд-ржорзБржЦ ржзрзБрзЯрзЗ ржирж╛ржУ, ржкрж░рж┐ржмрж╛рж░рзЗрж░ рж╕рж╛ржерзЗ ржПржХржЯрзБ ржЧрж▓рзНржк-ржЯрж▓рзНржк ржХрж░рзЛ, ржПржЗ ржЯрж╛ржЗржорзЗрж░ рж╕рзНржорзГрждрж┐ржЧрзБрж▓рзЛржЗ ржкрж░рзЗ ржмрзЗрж╢рж┐ ржоржирзЗ ржерж╛ржХрзЗ тЭдя╕П",

  "19": "ЁЯХМ рж╕ржирзНржзрзНржпрж╛ рзнржЯрж╛ ржмрж╛ржЬрзЗред\nрж╕ржмрж╛ржЗ ржирж╛ржорж╛ржЬ/ржЗржмрж╛ржжржд рж╕рзЗрж░рзЗ рждрж╛рж░ржкрж░ ржорзЗрж╕рзЗржЮрзНржЬрж╛рж░/ржЧрзЗржЗржотАФржкрзНрж░рж╛ржпрж╝рзЛрж░рж┐ржЯрж┐ ржЖржЧрзЗ ржарж┐ржХ ржХрж░рзЛ ЁЯШЙ",

  "20": "ЁЯУЪ рж░рж╛ржд рзоржЯрж╛ ржмрж╛ржЬрзЗред\nржкрзЬрж╛рж╢рзЛржирж╛, ржЕржирж▓рж╛ржЗржи ржХрзЛрж░рзНрж╕, рж╕рзНржХрж┐рж▓ ржбрзЗржнрзЗрж▓ржк тАУ ржЕржирзНрждржд рзйрзж-рзмрзж ржорж┐ржирж┐ржЯ рж╕рж┐рж░рж┐рзЯрж╛рж╕рж▓рж┐ ржХрж┐ржЫрзБ рж╢рж┐ржЦрзЛред ржнржмрж┐рж╖рзНржпрждрзЗрж░ рждрзБржорж┐ ржЖржЬржХрзЗрж░ рждрзЛржорж╛ржХрзЗ ржзржирзНржпржмрж╛ржж ржжрзЗржмрзЗ тЬи",

  "21": "ЁЯШВ рж░рж╛ржд рзпржЯрж╛ ржмрж╛ржЬрзЗред\nржЧрзНрж░рзБржкрзЗ рж╣рж╛рж▓ржХрж╛ ржЖржбрзНржбрж╛, ржорж┐ржо, ржоржЬрж╛ тАУ рждржмрзЗ ржирзЛ ржЯржХрзНрж╕рж┐ржХ, ржирзЛ ржбрзНрж░рж╛ржорж╛; ржкржЬрж┐ржЯрж┐ржн ржнрж╛ржЗржмрж╕ ржЕржирж▓рж┐ тЬи",

  "22": "ЁЯЫПя╕П рж░рж╛ржд рззрзжржЯрж╛ ржмрж╛ржЬрзЗред\nржорзЛржмрж╛ржЗрж▓рзЗрж░ ржЪрж╛рж░рзНржЬрзЗрж░ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗ ржирж┐ржЬрзЗрж░ ржЪрж╛рж░рзНржЬржУ ржлрзБрж▓ ржХрж░рзЗ ржирж╛ржУ тАУ ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржи ржЕржл ржХрж░рзЗ ржШрзБржорзЗрж░ ржкрзНрж░рж╕рзНрждрзБрждрж┐ ржирж╛ржУ ЁЯШ┤",

  "23": "ЁЯМЩ рж░рж╛ржд рззрззржЯрж╛ ржмрж╛ржЬрзЗред\nржпрж╛ржжрзЗрж░ рж╕ржХрж╛рж▓ржмрзЗрж▓рж╛рж░ ржЕрзНржпрж╛рж▓рж╛рж░рзНржо рж╕рзЗржЯ ржХрж░рж╛ рж╣рзЯржирж┐, ржПржЦржиржЗ ржХрж░рзЗ рж░рж╛ржЦрзЛ; рждрж╛рж░ржкрж░ тАШрж╢рзЗрж╖ рж╕рзНржХрзНрж░рж▓тАЩ ржХрж░рзЗ рж▓ржЧржЖржЙржЯ рж╣рзЯрзЗ ржпрж╛ржУ ЁЯШЙ"
};

// ЁЯФ╣ last sent hour load
function getLastHour() {
  if (!fs.existsSync(DATA_FILE)) return null;
  try {
    return JSON.parse(fs.readFileSync(DATA_FILE)).hour;
  } catch {
    return null;
  }
}

// ЁЯФ╣ save last sent hour
function setLastHour(hour) {
  fs.writeFileSync(DATA_FILE, JSON.stringify({ hour }));
}

module.exports = {
  config: {
    name: "tessaHourlyRoutine",
    category: "events"
  },

  onStart: async function () {},

  onLoad: async function ({ api, threadsData }) {
    setInterval(async () => {
      const now = moment().tz(TIMEZONE);

      // ржмрж░рзНрждржорж╛ржи ржШржирзНржЯрж╛ (00тАУ23)
      const currentHour = now.format("HH");

      // рж╢рзЗрж╖ ржкрж╛ржарж╛ржирзЛ ржШржирзНржЯрж╛
      const lastHour = getLastHour();

      // тЭМ ржПржХржЗ ржШржирзНржЯрж╛ рж╣рж▓рзЗ ржХрж┐ржЫрзБржЗ ржХрж░ржмрзЗ ржирж╛
      if (currentHour === lastHour) return;

      // ЁЯФ╣ ржЖржЧрзЗрж░ ржШржирзНржЯрж╛рж░ ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржмрзЗ
      const sendHour = lastHour === null
        ? currentHour
        : String((parseInt(lastHour) + 1) % 24).padStart(2, "0");

      const text = routine[sendHour];
      if (!text) {
        setLastHour(currentHour);
        return;
      }

      const msg =
        `${header}ЁЯХТ ${now.format("hh:mm A")}\n\n${text}`;

      const threads = await threadsData.getAll();
      for (const t of threads) {
        if (t.threadID) {
          api.sendMessage(msg, t.threadID).catch(() => {});
        }
      }

      // тЬЕ hour update
      setLastHour(sendHour);

    }, 60 * 1000); // ржкрзНрж░рждрж┐ ржорж┐ржирж┐ржЯрзЗ ржЪрзЗржХ
  }
};
